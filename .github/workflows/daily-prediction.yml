# .github/workflows/daily-prediction.yml
name: Daily Nifty50 AI Oracle

on:
  schedule:
    - cron: '0 3 * * *'    # 8:30 AM IST
  workflow_dispatch:

jobs:
  predict:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies (WORKS ON LINUX)
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy scikit-learn joblib tensorflow
          pip install pandas_ta
          pip install --no-deps ta   # optional fallback

      - name: Run Full Prediction
        run: |
          python - <<EOF
          from datetime import datetime
          from src.predict import predict_tomorrow, predict_next_close
          
          direction, confidence, probs = predict_tomorrow()
          predicted_price = predict_next_close()
          
          today = datetime.now().strftime('%Y-%m-%d')
          line = f"{today},{direction},{confidence:.1%},{probs[1]*100:.1f}%,₹{predicted_price:,.2f}\n"
          
          file = 'predictions.txt'
          if not open(file, 'a+', encoding='utf-8').read().strip():
              open(file, 'w').write("Date,Direction,Confidence,Bullish%,Predicted_Close\n")
          
          with open(file, 'r+') as f:
              if today not in f.read():
                  f.write(line)
                  print(f"PREDICTED → {today} | {direction} | {confidence:.1%} | ₹{predicted_price:,.2f}")
          EOF

      - name: Commit & Push
        run: |
          git config --global user.name "Nifty50 Oracle"
          git config --global user.email "oracle@bot.com"
          git add predictions.txt
          git commit -m "Oracle Update $(date '+%Y-%m-%d')" || exit 0
          git push || exit 0