# .github/workflows/daily-prediction.yml
name: Daily Nifty50 AI Oracle

on:
  schedule:
    - cron: '0 3 * * *'    # 8:30 AM IST
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install packages (compatible pandas-ta version)
        run: |
          pip install --upgrade pip
          pip install yfinance pandas numpy scikit-learn joblib tensorflow --quiet
          pip install "pandas-ta<0.4.0" --quiet  # ← THIS IS THE MAGIC: Older version for Python 3.11

      - name: Run prediction (your original code unchanged)
        run: |
          python -c "
          import os; import sys; sys.path.insert(0, '.')
          from datetime import datetime
          from src.predict import predict_tomorrow, predict_next_close
          
          direction, conf, probs = predict_tomorrow()
          price = predict_next_close()
          today = datetime.now().strftime('%Y-%m-%d')
          line = f'{today},{direction},{conf:.1%},{probs[1]*100:.1f}%,₹{price:,.2f}\n'
          
          file = 'predictions.txt'
          if not open(file, 'a+', encoding='utf-8').read().strip():
              open(file, 'w').write('Date,Direction,Confidence,Bullish%,Predicted_Close\n')
          
          if today not in open(file).read():
              open(file, 'a').write(line)
              print(f'ORACLE → {direction} | {conf:.1%} | ₹{price:,.2f}')
          "

      - name: Commit & Push
        run: |
          git config --global user.name "Nifty50 Oracle"
          git add predictions.txt
          git commit -m "Oracle Update $(date '+%Y-%m-%d')" || exit 0
          git push || exit 0