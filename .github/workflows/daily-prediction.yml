# .github/workflows/daily-prediction.yml
name: Daily Nifty50 AI Oracle

on:
  schedule:
    - cron: '0 3 * * *'    # 8:30 AM IST
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          # Pin numpy<2.0 to avoid compatibility issues with pandas-ta/tensorflow
          pip install "numpy<2.0" yfinance pandas scikit-learn joblib tensorflow --quiet
          # Install pandas-ta directly from the development branch for best compatibility
          pip install git+https://github.com/twopirllc/pandas-ta.git@development --quiet

      - name: Run prediction
        run: |
          python -c "
          import sys, os
          sys.path.insert(0, '.')
          from datetime import datetime
          from src.predict import predict_tomorrow, predict_next_close
          
          direction, conf, probs = predict_tomorrow()
          price = predict_next_close()
          today = datetime.now().strftime('%Y-%m-%d')
          line = f'{today},{direction},{conf:.1%},{probs[1]*100:.1f}%,₹{price:,.2f}\n'
          
          file = 'predictions.txt'
          header = 'Date,Direction,Confidence,Bullish%,Predicted_Close\n'
          if not os.path.exists(file):
              open(file, 'w').write(header)
          
          if today not in open(file).read():
              open(file, 'a').write(line)
              print(f'SUCCESS → {today} | {direction} | {conf:.1%} | ₹{price:,.2f}')
          else:
              print('Already predicted today')
          "

      - name: Commit & Push
        run: |
          git config --global user.name "Nifty50 Oracle"
          git add predictions.txt
          git commit -m "Oracle Update $(date '+%Y-%m-%d')" || exit 0
          git push || exit 0